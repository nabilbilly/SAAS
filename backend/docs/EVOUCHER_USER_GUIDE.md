# E-Voucher Module User Guide

This guide explains how to use the E-Voucher system in **cschool**, enabling admins to generate vouchers and students/applicants to verify them for admission.

## Overview
The E-Voucher module manages the lifecycle of admission vouchers:
1.  **Creation**: Generated by Admins for a specific Academic Year.
2.  **Unused**: Ready for purchase/distribution.
3.  **Reserved**: Temporarily locked (15 mins) when an applicant verifies it.
4.  **Used**: Permanently linked to a student admission (not yet implemented).
5.  **Expired/Revoked**: Invalid for use.

---

## 1. Prerequisites (Admin)

Before generating vouchers, you must have an **Active Academic Year**.

### Create Academic Year
**Endpoint**: `POST /api/v1/academics/`

**Request**:
```json
{
  "name": "2026/2027",
  "status": "Active"
}
```

**Response**:
Returns the created year object with its `id`. Note this `id` for voucher creation.

---

## 2. Managing Vouchers (Admin)

### Generate Vouchers
**Endpoint**: `POST /api/v1/evoucher/admin/vouchers`

Generates a batch of vouchers with secure 6-digit PINs.
Before you set up a voucher for a new system for particular year, make sure these are seup as t
1. overall vouchers for that year./api/v1/evoucher/admin/vouchers
2. 

**Request**:
```json
{
  "academic_year_id": 1,
  "count": 50,
  "expires_at": "2026-12-31T23:59:59"
}
```
*   `count`: Number of vouchers to generate (max 1000 per batch).
*   `expires_at`: Date/Time when vouchers become invalid.

**Response**:
Returns a list of created vouchers **including the plain text PINs**.
> [!IMPORTANT]
> This is the **ONLY** time the PINs are shown. Save this data or export it immediately (e.g., to CSV for printing cards). The database stores only the hash.

### List Vouchers
**Endpoint**: `GET /api/v1/evoucher/admin/vouchers`

View all vouchers. Can filter by status or year.

**Parameters**:
*   `academic_year_id` (optional): Filter by year.
*   `status` (optional): `Unused`, `Reserved`, `Used`, `Expired`, `Revoked`.
*   `skip` / `limit`: Pagination.

### Cleanup Expired Reservations
**Endpoint**: `DELETE /api/v1/evoucher/admin/cleanup-reservations`

Manually releases vouchers that have been "Reserved" for longer than 15 minutes. This is useful if the automatic check needs a manual trigger or for maintenance.

---

## 3. Applicant Workflow (Public)

These endpoints are used by the Admission Portal UI.

### Verify Voucher
**Endpoint**: `POST /api/v1/evoucher/verify`

The entry gate for admission.

**Request**:
```json
{
  "voucher_number": "1234567890",
  "pin": "123456"
}
```

**Response (Success)**:
```json
{
  "valid": true,
  "voucher_session_token": "a1b2c3d4-...",
  "expires_at": "2026-01-20T12:15:00"
}
```
*   **Result**: The voucher status changes to **Reserved**.
*   **Token**: The frontend must store the `voucher_session_token`. It is required for subsequent admission steps.

**Response (Failure)**:
```json
{
  "valid": false,
  "reason": "InvalidPIN" 
}
```
Possible reasons: `InvalidPIN`, `NotFound`, `Expired`, `Used`, `Reserved` (by someone else).

### Check Session Status
**Endpoint**: `GET /api/v1/evoucher/check-session/{session_token}`

Frontend should call this periodically (or on page load) to ensure the reservation is still active.

**Response**: Same as Verify. If expired, `valid` will be `false` with reason `Expired`.

### Release Session (Cancel)
**Endpoint**: `DELETE /api/v1/evoucher/release-session/{session_token}`

Call this if the user clicks "Cancel" or "Logout" during admission. It immediately frees the voucher for others to use (sets status back to **Unused**).

---

## 4. Security Notes
*   **PIN Storage**: PINs are hashed using BCrypt. Even database admins cannot see the original PINs.
*   **Rate Limiting**: (To be implemented) Repeated failures should block the IP.
*   **Concurrency**: The "Reserved" status prevents two students from using the same voucher simultaneously.
